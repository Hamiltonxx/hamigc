<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>coding</title>
    <link rel="stylesheet" href="../styles/global.css" />
    <link rel="stylesheet" href="../styles/index.css" />
    <link rel="stylesheet" href="../styles/github-dark.min.css" />
    <link rel="stylesheet" href="../assets/fonts/iconfont.css" />
    <script src="../javascript/highlight.min.js"></script>
    <script src="../javascript/axios.min.js"></script>
    <script src="../javascript/request.js"></script>
    <!-- 弹框插件 -->
    <link rel="stylesheet" href="../assets/plugins/sweetaleat/sweetaleat.css" />
    <script src="../assets/plugins/sweetaleat/sweetalert.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">Python 教程</div>
        </div>

        <div class="wrapper">
            <div class="class"></div>

            <div class="content">
                <div class="ques">
                    <h2 id="title"></h2>
                    <div id="description"></div>
                </div>
                <button onclick="handleSubmit()">提交</button>
                <div class="code-area">
                    <pre>
                        <code id="code" class="python"></code>
                    </pre>
                    <code 
                        autofocus 
                        contenteditable
                        oninput="handleInput()"
                        id="textarea"
                        spellcheck="false"
                    ></code>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
getCollections();

var collections = [];
var problems = [];
/**
 * 获取题集
 */
function getCollections() {
    request({
        url: '/collections',
        method: 'get',
        success: function (res) {
            collections = res;

            renderCollection(res);
        },
        fail: function (err) {
            errorAlert('获取题集发生错误');
            console.log(err);
        }
    });
}

/**
 * 渲染题集
 */
function renderCollection(list) {
    var template = function (text, index) {
        return '<div class="co-title' + (index == 0 ? ' active' : '') + '" id="title-' + index + '">' 
            + '<div class="co-title-text" onclick="handleSelectCollection('+ index +')">'
            + '<span class="icon"><i class="iconfont icon-xiangyou"></i></span>'
            + text 
            + '</div>'
            + '<div class="questions" id="question-' + index + '"></div>'
            + '</div>';
    };

    var html = '';

    for (var i = 0; i < list.length; i++) {
        html += template(list[i].name, i);
    }

    document.querySelector('.class').innerHTML = html;   
    
    getProblems();
}

/**
 * 添加了题集的点击事件
 */
function handleSelectCollection(index) {
    var dom = document.querySelector('#title-' + index);

    if (dom.className.indexOf('active') > -1) {
        dom.className = 'co-title';

        document.querySelector('#question-0').style.display = 'none';
    } else {
        dom.className = 'co-title active';

        document.querySelector('#question-0').style.display = 'block';
    }
}

/**
 * 获取题目
 */
function getProblems() {
    request({
        url: '/problems',
        method: 'get',
        success: function (res) {
            problems = res;

            renderProblem(res);
        },
        fail: function (err) {
            errorAlert('获取题目发生错误');
            console.log(err)
        }
    });
}

/**
 * 渲染题目
 */
function renderProblem(list) {
    var template = function (text, id, index) {
        return '<div class="question question-'+ index +'" onclick="handleSelectProblem('+ id +', '+ index +')">'
            + '<span class="arc"><span></span></span>'
            + (index + 1) + '、'
            + text
            + '</div>'
    };

    var html = '';

    for (var i = 0; i < list.length; i++) {
        html += template(list[i].title, list[i].id, i);
    }
    
    document.querySelector('#question-' + 0).innerHTML = html;

    setTimeout(function () {
        handleSelectProblem(list[0].id, 0);
    }, 100);
}

/**
 * 点击题目
 */
var title_dom = document.querySelector('#title');
var description_dom = document.querySelector('#description');
function handleSelectProblem(id, index) {
    var target = {};

    for (var i = 0; i < problems.length; i++) {
        if (problems[i].id == id) {
            target = problems[i];
        }
    }

    // 渲染内容区域
    title_dom.innerHTML = index + 1 + '、' + target.title;
    description_dom.innerHTML = target.description.split('\n').join('<br />');
    code_dom.innerHTML = target.codeinit.replace(/\r\n/g,"<br>");
    textarea_dom.innerText = target.codeinit;

    init();

    // 渲染左侧导航栏
    var questions = document.querySelectorAll('.question');
    for (var j = 0; j < questions.length; j++) {
        questions[j].className = questions[j].className.replace(' arc-active', '');
    }

    var current = document.querySelector('.question-' + index);
    
    current.className = current.className + ' arc-active';
}

/**
 * 提交代码
 */
function handleSubmit() {
    let id = '';

    try {
        id = JSON.parse(localStorage.getItem('python_token')).id;
    } catch(err) {
        console.log(err);
    };

    request({
        url: '/submission',
        method: 'post',
        data: {
            pid: id,
            codes: textarea_dom.innerText
        },
        success: function (res) {
            console.log(res);
        },
        fail: function (err) {
            errorAlert("提交失败");
        }
    });
}
</script>
<script>
    var code_dom = document.querySelector('#code');
    var textarea_dom = document.querySelector('#textarea');
    
    init();

    /**
     * 重置渲染方法
     */
    function init() {
        code_dom.removeAttribute('data-highlighted');

        hljs.highlightAll();
    }

    /**
     * 监听输入事件 将换行符 替换成 换行标签
     */
    function handleInput() {
        let text = textarea_dom.innerText.replace(/\r\n/g,"<br>");

        code_dom.innerHTML = text;

        init();
    }

    /**
     * 按下 tab 键增加 4个 空格符
     */
     textarea_dom.addEventListener('keydown', e => {
        return ;
        if (e.keyCode === 9) {
            var doc = textarea.ownerDocument.defaultView;
            var sel = doc.getSelection();
            var rang = sel.getRangeAt(0);

            var tabNode = document.createTextNode("\u00a0\u00a0\u00a0\u00a0");

            rang.insertNode(tabNode);
            rang.setStartAfter(tabNode);
            rang.setEndAfter(tabNode);
            sel.removeAllRanges();
            sel.addRange(rang);

            e.preventDefault();
        }
    }, false);

/**
 * 错误弹框
 */
function errorAlert(text) {
    Swal.fire({
        icon: "warning",
        text: text,
    });
}
</script>
</html>