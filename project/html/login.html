<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录</title>
    <link rel="stylesheet" href="../styles/global.css" />
    <link rel="stylesheet" href="../styles/login.css" />
    <script src="../javascript//axios.min.js"></script>
    <script src="../javascript/request.js"></script>
    <!-- 弹框插件 -->
    <link rel="stylesheet" href="../assets/plugins/sweetaleat/sweetaleat.css" />
    <script src="../assets/plugins/sweetaleat/sweetalert.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="logo">
            <span>Python</span>
        </div>
        <div class="login">
            <div class="wrapper">
                <div class="title">登录</div>

                <div class="form">
                    <div class="form-item">
                        <span class="label">手机号</span>
                        <input type="phone" id="phone" autocomplete="off" />
                    </div>
                    <div class="form-item">
                        <span class="label">验证码</span>
                        <input type="text" id="code" autocomplete="off" readonly />
                        <button class="get-code" id="getCode">获取验证码</button>
                    </div>
                    <button class="submit" onclick="submit()">
                        登录
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
// 手机号输入框
var phone_dom = document.querySelector('#phone');
// 验证码输入框
var code_dom = document.querySelector('#code');
// 获取验证码按钮
var get_code_dom = document.querySelector('#getCode');

// 添加 focus 事件
phone_dom.addEventListener('focus', inputFocus, false);
code_dom.addEventListener('focus', inputFocus, false);
// 添加 blur 事件
phone_dom.addEventListener('blur', inputBlur, false);
code_dom.addEventListener('blur', inputBlur, false); 
// 添加获取验证码事件
get_code_dom.addEventListener('click', getCode, false);
// 添加回车登录事件
code_dom.addEventListener('keydown', function (e){
    if (e.keyCode != 13) return ;

    submit();
}, false);

/**
 * 输入框聚焦
 */
function inputFocus(e) {
    var form_item = e.target.parentNode;

    if (e.target.value) return ;

    form_item.className = 'form-item active';
    e.target.style.zIndex = 0;
}

/**
 * 输入框失焦事件
 */
function inputBlur(e) {
    var form_item = e.target.parentNode;

    if (e.target.value) return ;

    form_item.className = 'form-item';
    e.target.style.zIndx = 2;
}

/**
 * 获取验证码
 */
var code_flag = false; 
function getCode(e) {
    if (phone_dom.value) {
        if (code_flag) return ;

        code_flag = true;

        sendGetCodeRequest(e);
    } else {
        errorAlert('请填写手机号');
    }
}

function wait5Second(e) {
    var time = 5;

    var timer = setInterval(function () {
        time--;

        if (time == 0) {
            code_flag = false;
            e.target.innerText = '获取验证码';
            clearInterval(timer);
            return ;
        }

        e.target.innerText = '重新发送(' + time + ')';
    }, 1000);
}

/**
 * 发送获取验证码请求
 */
function sendGetCodeRequest(e) {
    request({
        url: '/send_vericode',
        method: 'post',
        data: {
            phone: phone_dom.value
        },
        success: function (res) {
            code_dom.focus();
            code_dom.value = res.vericode;

            Swal.fire({
                icon: "success",
                title: "success",
                text: '获取验证码成功，请点击登录吧',
            });
            

            wait5Second(e);
        },
        fail: function (err) {
            errorAlert('获取验证码错误');
            console.log(err);
        }
    })
}

/**
 * 提交
 */
function submit() {
    if (!phone_dom.value) return errorAlert('请填写手机号');

    if (!code_dom.value) return errorAlert('请填写验证码');

    request({
        url: '/vericode_login',
        method: 'post',
        data: {
            phone: phone_dom.value,
            vericode: code_dom.value
        },
        success: function (res) {
            localStorage.setItem('python_token', JSON.stringify(res));

            location.href = './index.html';
        },
        fail: function (err) {
            errorAlert('登录失败');
            console.log(err);
        }
    });
}

/**
 * 错误弹框
 */
function errorAlert(text) {
    Swal.fire({
        icon: "warning",
        text: text,
    });
}
</script>
</html>